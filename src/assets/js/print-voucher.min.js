const { PDFDocument, rgb, StandardFonts } = require('pdf-lib');
const fs = require('fs');
const path = require('path');
const print = require('pdf-to-printer');

const tempFilePath = path.join(__dirname, 'Nuevo.pdf'); // Ruta para guardar el archivo temporal

async function createPDF(nombreCliente, cedulaCliente) {
    const pdfDoc = await PDFDocument.create();
    const pageHeight = 210; // Altura de la página en puntos
    const page = pdfDoc.addPage([58 * 2.83465, pageHeight]); // Tamaño de la página en puntos
    const { height } = page.getSize();

    const timesRomanFont = await pdfDoc.embedFont(StandardFonts.TimesRoman);
    
    // Ajustamos la posición inicial y el tamaño de la fuente
    let yPosition = height - 10;
    const fontSize = 8; // Tamaño de la fuente ajustado

    // Definir el contenido y las posiciones
    const contents = [
        '----------- TICKET -----------',
        'Nombre de la Tienda: CORPORACION FIBEXTELECOM C.A.',
        `Nombre del Cliente: ${nombreCliente}`,
        `Cédula del Cliente: ${cedulaCliente}`,
        'Dirección: SECT LOS COLORADOS # 103-5, VALENCIA',
        `Fecha: ${new Date().toLocaleString()}`,
        'Recibo de Pago: 447913',
        'Nro Abonado: V66979',
        '------------------------------',
        'Descripción: MENS. OCT 2024',
        'Monto: $21,56 USD / 811,75 BS',
        'Forma de Pago: TARJETA DE DEBITO',
        'Total Recibo: $21,56 USD / 811,75 BS',
        'Saldo Actual: -1,17 USD / -44,05 BS',
        'Gracias por su pago!',
        'Fibex Telecom C.A.',
        '¡EL INTERNET QUE SI FUNCIONA!',
    ];

    contents.forEach(text => {
        page.drawText(text, { x: 10, y: yPosition, size: fontSize, font: timesRomanFont, color: rgb(0, 0, 0) });
        yPosition -= fontSize + 2; // Ajustar la posición Y para la siguiente línea
    });

    const pdfBytes = await pdfDoc.save();
    fs.writeFileSync(tempFilePath, pdfBytes);
    console.log('PDF creado y guardado en:', tempFilePath);
}

async function printFile(nombreCliente, cedulaCliente) {
    await createPDF(nombreCliente, cedulaCliente);

    print.print(tempFilePath)
        .then(() => {
            // fs.unlink(tempFilePath, (err) => {
            //     if (err) {
            //         console.error('Error al eliminar el archivo temporal:', err);
            //     }
            // });
            console.log('Impresión enviada');
        })
        .catch(err => {
            console.error('Error al imprimir:', err);
        });
}

// Ejemplo de uso
const nombreCliente = "Pablo Gutierrez";
const cedulaCliente = "V-28052291";

printFile(nombreCliente, cedulaCliente);
